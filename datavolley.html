<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Data-Volley Input</title>
    </head>
    <body>
        <h2>Parsing DV-Strings</h2>
        Parser for scouting strings. Paste them into the text area below and press "Analyze". 
        <textarea id="tdata" rows="8" cols="60">
        </textarea>
        <p>
            <button onclick="analyze()">Analyze</button>
        </p>
        <h2>Results</h2>
        <table>
            <thead>
                <th>Serve</th>
                <th>Receive</th>
            </thead>
            <tbody>
                <tr>
                    <td><textarea id="sdata" rows="16" cols="80"></textarea></td>
                    <td><textarea id="rdata" rows="16" cols="80"></textarea></td>
                </tr>
                <tr>
                    <th>Attack</th>
                    <th>Dig</th>
                </tr>
                <tr>
                    <td><textarea id="adata" rows="16" cols="80"></textarea></td>
                    <td><textarea id="ddata" rows="16" cols="80"></textarea></td>
                </tr>
            </tbody>
        </table>
    </body>
    <script>
     /**
      * Create a new data object.
      */
     function makeZap(name){
         obj = new Object();
         obj.name = name;
         obj.data = {
             S : {'=':  0, '/': 0, '-': 0, '!': 0, '+' : 0, '#' :0, cnt: 0 },
             R : {'=':  0, '/': 0, '-': 0, '!': 0, '+' : 0, '#' :0, cnt: 0 },
             A : {'=':  0, '/': 0, '-': 0, '!': 0, '+' : 0, '#' :0, cnt: 0 },
             B : {'=':  0, '/': 0, '-': 0, '!': 0, '+' : 0, '#' :0, cnt: 0 },
             D : {'=':  0, '/': 0, '-': 0, '!': 0, '+' : 0, '#' :0, cnt: 0 },
             E : {'=':  0, '/': 0, '-': 0, '!': 0, '+' : 0, '#' :0, cnt: 0 },
             F : {'=':  0, '/': 0, '-': 0, '!': 0, '+' : 0, '#' :0, cnt: 0 },
         };
         return obj;
     }

     // http://www.vbl-wiki.de/wiki/Hauptseite
     /*
        let skillWeights = {
        S: {'=':  0, '/': 8, '-': 4, '!': 5, '+' : 7, '#' :10 },
        R: {'=': -3, '/':-3, '-':-2, '!':-1, '+' : 7, '#' :10 },
        A: {'=':  0, '/': 0, '-': 5, '!': 7, '+' : 7, '#' :10 },
        B: {'=':  0, '/': 0, '-': 0, '!': 5, '+' : 5, '#' :10 },
        D: {'=':  0, '/':10, '-': 2, '!': 3, '+' : 5, '#' :10 },
        E: {'=':  0, '/': 0, '-': 0, '!': 0, '+' : 7, '#' :10 },
        F: {'=':  0, '/':10, '-': 2, '!': 5, '+' : 5, '#' :10 },
        };
      */
     let skillWeights = {
         S: {'=':  0, '/': 0.5, '-': 1, '!': 2, '+' : 3, '#' :4 },
         R: {'=':  0, '/': 0.5, '-': 1, '!':-9, '+' : 2, '#' :3 },
         A: {'=':  0, '/':   0, '-': 5, '!': 7, '+' : 7, '#' :10 },
         B: {'=':  0, '/':   0, '-': 0, '!': 5, '+' : 5, '#' :10 },
         D: {'=':  0, '/':  10, '-': 2, '!': 3, '+' : 5, '#' :10 },
         E: {'=':  0, '/':   0, '-': 0, '!': 0, '+' : 7, '#' :10 },
         F: {'=':  0, '/':  10, '-': 2, '!': 5, '+' : 5, '#' :10 },
     };
     /**
      * For chained data. Map the response judgement to the judgement
      * of the initial skill.
      */
     let btValMap = {
         R: {os:'S', '/':'/', '#':'-', '+':'!', '-':'+', '=':'#' },
     }
     /**
      * Analyze the input textarea
      */
     function analyze(){
         let myZap = new Object();
         // FIXME: These should be created on the fly, or from ini file
         myZap['ANH'] = makeZap('Anna');
         myZap['CAB'] = makeZap('Cathi');
         myZap['EMD'] = makeZap('Emily');
         myZap['FAJ'] = makeZap('Fati');
         myZap['LEB'] = makeZap('Lena');
         myZap['MAH'] = makeZap('Marie');
         myZap['MIK'] = makeZap('Milena');
         myZap['PAD'] = makeZap('Paula D');
         myZap['PAE'] = makeZap('Paula E');
         myZap['PID'] = makeZap('Pia');
         myZap['REZ'] = makeZap('Becci');
         myZap['TAS'] = makeZap('Tami');

         myZap['LAK'] = makeZap('Lasse');
         myZap['JUM'] = makeZap('Julian');
         myZap['JUK'] = makeZap('Julius');
         myZap['XXX'] = makeZap('XXX');
         //
         document.getElementById('sdata').value = '';
         document.getElementById('rdata').value = '';
         document.getElementById('adata').value = '';
         document.getElementById('ddata').value = '';

         let lines = document.getElementById('tdata').value.trim().split('\n');
         console.log('************************');
         lines.forEach(function(line){
             let re = /(a|\*)*([A-Z]{3}|\d{1,2})([srabdef])([hmqtufo])*([-+!=#.\/])/;
             let doBT = false;
             while ( match = re.exec(line) ){
                 let team      = match[1] === undefined ? '*' : 'a';
                 let playerTag = match[2];
                 let skill     = match[3].toUpperCase();
                 let speed     = match[4] === undefined ? undefined : match[4].toUpperCase();
                 let valchr    = match[5];
                 if( valchr === '.' ){
                     doBT    = true;
                     btPT    = playerTag;
                     btSkill = skill;
                 }
                 else{
                     if(doBT){
                         // Map new value to old Value
                         myZap[btPT].data[btSkill][btValMap[skill][valchr]] += 1;
                         myZap[btPT].data[btSkill].cnt += 1;
                         doBT = false;
                     }
                     myZap[playerTag].data[skill][valchr] += 1;
                     myZap[playerTag].data[skill].cnt += 1;
                 }
                 line = line.substring(match[0].length);
             }
         });
         console.log('Done lines');
         Object.entries(myZap).forEach(([key, obj])=>{
             let pts = obj.data.S['=']*0
                     + obj.data.S['/']*0.5
                     + obj.data.S['-']*1
                     + obj.data.S['!']*2
                     + obj.data.S['+']*3
                     + obj.data.S['#']*4;
             document.getElementById('sdata')
                     .value += obj.name
                             + '\t' + obj.data.S['#']
                             + '\t' + pts
                             + '\t' + obj.data.S.cnt
                             + '\t' + obj.data.S['=']
                             + '\t' + obj.data.S['/']
                             + '\t' + obj.data.S['+']
                             + '\t' + obj.data.S['!']
                             + '\t' + obj.data.S['-']
                             + '\t' + obj.data.S['#']
                             + '\n';
             pts = obj.data.R['=']*0
                 + obj.data.R['/']*0.5
                 + obj.data.R['-']*1
                 + obj.data.R['!']*2000
                 + obj.data.R['+']*2
                 + obj.data.R['#']*3;
             document.getElementById('rdata')
                     .value += obj.name
                             + '\t' + obj.data.R['=']
                             + '\t' + pts
                             + '\t' + obj.data.R.cnt
                             + '\t' + obj.data.R['=']
                             + '\t' + obj.data.R['/']
                             + '\t' + obj.data.R['+']
                             + '\t' + obj.data.R['!']
                             + '\t' + obj.data.R['-']
                             + '\t' + obj.data.R['#']
                             + '\n';
         });
     }
    </script>
</html>
